import express from "express";
import cors from "cors";
import OpenAI from "openai";

const app = express();

// Ð·Ð±Ñ–Ð»ÑŒÑˆÑƒÑ”Ð¼Ð¾ Ð»Ñ–Ð¼Ñ–Ñ‚ Ð´Ð»Ñ Ð²ÐµÐ»Ð¸ÐºÐ¸Ñ… Ð¼Ð°ÑÐ¸Ð²Ñ–Ð² (Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´, 10mb)
app.use(express.json({ limit: "10mb" }));

// Ð´Ð¾Ð·Ð²Ð¾Ð»ÑÑ”Ð¼Ð¾ Ð·Ð°Ð¿Ð¸Ñ‚Ð¸ Ð· Ñ‚Ð²Ð¾Ð³Ð¾ Qlik-Ð´Ð¾Ð¼ÐµÐ½Ñƒ
app.use(cors({
  origin: "https://bi_qlik.accordbank.com.ua"
}));

// Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ OpenAI
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// Ð¡Ð»Ð¾Ð²Ð½Ð¸Ðº ÑÑ‚Ð¸Ð»Ñ–Ð² Ñ–Ð· Ð²Ð°Ñ€Ñ–Ð°Ð½Ñ‚Ð°Ð¼Ð¸ + Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡Ð½Ñ– ÐµÐ¼Ð¾Ð´Ð·Ñ–
const vizPrompts = {
  "table": [
    "Ð£ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ“‹",
    "Ð¢Ð°Ð±Ð»Ð¸Ñ†Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“‹",
    "Ð— Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ– Ð¼Ð¾Ð¶Ð½Ð° Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ ðŸ“‹",
    "Ð¢Ð°Ð±Ð»Ð¸Ñ‡Ð½Ñ– Ð´Ð°Ð½Ñ– Ð¿Ð¾ÐºÐ°Ð·ÑƒÑŽÑ‚ÑŒ ðŸ“‹"
  ],
  "pivot-table": [
    "Ð£ Ð¿Ñ–Ð²Ð¾Ñ‚Ñ– ÑÐ¿Ð¾ÑÑ‚ÐµÑ€Ñ–Ð³Ð°Ñ”Ñ‚ÑŒÑÑ ðŸ“Š",
    "ÐŸÑ–Ð²Ð¾Ñ‚-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "Ð— Ð¿Ñ–Ð²Ð¾Ñ‚-Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š"
  ],
  "map": [
    "ÐÐ° ÐºÐ°Ñ€Ñ‚Ñ– Ð¼Ð¾Ð¶Ð½Ð° Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ ðŸ—ºï¸",
    "ÐšÐ°Ñ€Ñ‚Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ—ºï¸",
    "Ð— ÐºÐ°Ñ€Ñ‚Ð¸ Ð²Ð¸Ð´Ð½Ð¾ ðŸ—ºï¸"
  ],
  "barchart": [
    "ÐÐ° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š",
    "Ð¡Ñ‚Ð¾Ð²Ð¿Ñ‡Ð¸ÐºÐ¸ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑŽÑ‚ÑŒ ðŸ“Š",
    "Ð‘Ð°Ñ€-Ñ‡Ð°Ñ€Ñ‚ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "Ð— Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð¸ Ð¼Ð¾Ð¶Ð½Ð° Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ ðŸ“Š"
  ],
  "linechart": [
    "Ð“Ñ€Ð°Ñ„Ñ–Ðº Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“ˆ",
    "Ð›Ñ–Ð½Ñ–Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“ˆ",
    "ÐÐ° Ð³Ñ€Ð°Ñ„Ñ–ÐºÑƒ Ð²Ð¸Ð´Ð½Ð¾ ðŸ“ˆ",
    "Ð— Ð³Ñ€Ð°Ñ„Ñ–ÐºÐ° Ð¼Ð¾Ð¶Ð½Ð° Ð¿Ð¾Ð±Ð°Ñ‡Ð¸Ñ‚Ð¸ ðŸ“ˆ"
  ],
  "piechart": [
    "ÐšÑ€ÑƒÐ³Ð¾Ð²Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ©",
    "ÐŸÐ°Ð¹-Ñ‡Ð°Ñ€Ñ‚ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ©",
    "ÐÐ° ÐºÑ€ÑƒÐ³Ð¾Ð²Ñ–Ð¹ Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ©"
  ],
  "histogram": [
    "Ð“Ñ–ÑÑ‚Ð¾Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“Š",
    "ÐÐ° Ð³Ñ–ÑÑ‚Ð¾Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š",
    "Ð Ð¾Ð·Ð¿Ð¾Ð´Ñ–Ð» Ð½Ð° Ð³Ñ–ÑÑ‚Ð¾Ð³Ñ€Ð°Ð¼Ñ– Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š"
  ],
  "waterfallchart": [
    "ÐšÐ°ÑÐºÐ°Ð´Ð½Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸŒŠ",
    "Waterfall Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸŒŠ",
    "ÐÐ° ÐºÐ°ÑÐºÐ°Ð´Ð½Ñ–Ð¹ Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸŒŠ"
  ],
  "combochart": [
    "ÐšÐ¾Ð¼Ð±Ñ–Ð½Ð¾Ð²Ð°Ð½Ð¸Ð¹ Ð³Ñ€Ð°Ñ„Ñ–Ðº Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“Š",
    "ÐÐ° ÐºÐ¾Ð¼Ð±Ñ–Ð½Ð¾Ð²Ð°Ð½Ñ–Ð¹ Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š",
    "ÐšÐ¾Ð¼Ð±Ð¾-Ñ‡Ð°Ñ€Ñ‚ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š"
  ],
  "kpi": [
    "KPI-Ð¾Ð±â€™Ñ”ÐºÑ‚ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ñ ðŸŽ¯",
    "ÐÐ° KPI Ð²Ð¸Ð´Ð½Ð¾ ðŸŽ¯",
    "ÐŸÐ¾ÐºÐ°Ð·Ð½Ð¸Ðº KPI Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸŽ¯"
  ],
  "text-image": [
    "Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ð¸Ð¹ Ð±Ð»Ð¾Ðº Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“",
    "Ð—Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ–¼ï¸",
    "Ð¢ÐµÐºÑÑ‚/Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ Ð²Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ” ðŸ–¼ï¸"
  ],
  "funnelchart": [
    "Ð’Ð¾Ñ€Ð¾Ð½ÐºÐ° Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” Ñ€Ð¾Ð·Ð¿Ð¾Ð´Ñ–Ð» ðŸ”»",
    "Ð¤Ð°Ð½ÐµÐ»-Ñ‡Ð°Ñ€Ñ‚ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ”»",
    "ÐÐ° Ð²Ð¾Ñ€Ð¾Ð½Ñ†Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ”»"
  ],
  "radarchart": [
    "Ð Ð°Ð´Ð°Ñ€Ð½Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ•¸ï¸",
    "ÐÐ° Ñ€Ð°Ð´Ð°Ñ€Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ•¸ï¸",
    "Ð Ð°Ð´Ð°Ñ€Ð½Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ•¸ï¸"
  ],
  "default": [
    "Ð”Ð°Ð½Ñ– Ð¿Ð¾ÐºÐ°Ð·ÑƒÑŽÑ‚ÑŒ ðŸ“Š",
    "Ð— Ð´Ð°Ð½Ð¸Ñ… Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š",
    "Ð†Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑŽÑ‚ÑŒ ðŸ“Š"
  ]
};

// Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð²Ð¸Ð±Ð¾Ñ€Ñƒ Ð²Ð¸Ð¿Ð°Ð´ÐºÐ¾Ð²Ð¾Ð³Ð¾ Ð²Ð°Ñ€Ñ–Ð°Ð½Ñ‚Ñƒ
function pickPrompt(type) {
  const options = vizPrompts[type] || vizPrompts["default"];
  return options[Math.floor(Math.random() * options.length)];
}

// ÐžÑÐ½Ð¾Ð²Ð½Ð¸Ð¹ endpoint
app.post("/analyze", async (req, res) => {
  const { message, data, fields, vizType, metadata } = req.body;

  // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¸Ð¹ Ð²Ð¸Ð±Ñ–Ñ€ ÑÑ‚Ð¸Ð»ÑŽ
  const styleHint = pickPrompt(vizType);

  // Ð¤Ð¾Ñ€Ð¼ÑƒÑ”Ð¼Ð¾ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ñ–
  const prompt = `
    ÐšÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð½Ð°Ð¿Ð¸ÑÐ°Ð²: "${message}".
    Ð”Ð°Ð½Ñ–: ${JSON.stringify(data)}.
    ÐŸÐ¾Ð»Ñ: ${fields.join(", ")}.
    Ð¢Ð¸Ð¿ Ð²Ñ–Ð·ÑƒÐ°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ—: ${vizType}.
    
    ÐžÐ¿Ð¸ÑˆÐ¸ Ð´Ð°Ð½Ñ– Ñ‚Ð°Ðº, Ð½Ñ–Ð±Ð¸ Ñ‚Ð¸ Ð±Ð°Ñ‡Ð¸Ñˆ ${vizType}.
    Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ ÑÑ‚Ð¸Ð»ÑŒ Ñƒ Ð´ÑƒÑÑ–: "${styleHint}", Ð°Ð»Ðµ Ð²Ð°Ñ€Ñ–ÑŽÐ¹ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»ÑŽÐ²Ð°Ð½Ð½Ñ.
    Ð”Ð¾Ð´Ð°Ð²Ð°Ð¹ Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡Ð½Ñ– ÐµÐ¼Ð¾Ð´Ð·Ñ– Ð´Ð¾Ñ€ÐµÑ‡Ð½Ð¾ (ðŸ“Š, ðŸ“ˆ, ðŸ—ºï¸, ðŸŽ¯, ðŸ“, ðŸ–¼ï¸), Ñ‰Ð¾Ð± Ð·Ñ€Ð¾Ð±Ð¸Ñ‚Ð¸ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´ÑŒ Ð¶Ð¸Ð²Ð¾ÑŽ.
  `;

  try {
    const response = await client.chat.completions.create({
      model: "gpt-4.1-mini",
      messages: [{ role: "system", content: "Ð¢Ð¸ Ð°Ð½Ð°Ð»Ñ–Ñ‚Ð¸Ñ‡Ð½Ð¸Ð¹ Ð°ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð´Ð»Ñ Qlik Sense." },
                 { role: "user", content: prompt }]
    });

    res.json({ reply: response.choices[0].message.content });
  } catch (error) {
    console.error("Error calling OpenAI:", error);
    res.status(500).json({ error: "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ð¸ÐºÐ»Ð¸ÐºÑƒ Ð¼Ð¾Ð´ÐµÐ»Ñ–" });
  }
});

// Ð—Ð°Ð¿ÑƒÑÐº ÑÐµÑ€Ð²ÐµÑ€Ð°
app.listen(3000, () => {
  console.log("Backend running on port 3000");
});