import express from "express";
import cors from "cors";
import OpenAI from "openai";

const app = express();

// –∑–±—ñ–ª—å—à—É—î–º–æ –ª—ñ–º—ñ—Ç –¥–ª—è –≤–µ–ª–∏–∫–∏—Ö –º–∞—Å–∏–≤—ñ–≤ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, 10mb)
app.use(express.json({ limit: "10mb" }));

// –¥–æ–∑–≤–æ–ª—è—î–º–æ –∑–∞–ø–∏—Ç–∏ –∑ —Ç–≤–æ–≥–æ Qlik-–¥–æ–º–µ–Ω—É
app.use(cors({
  origin: "https://bi_qlik.accordbank.com.ua"
}));

// –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è OpenAI
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// –ø—Ä–æ—Å—Ç–∏–π –º–∞—Ä—à—Ä—É—Ç –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
app.get("/", (req, res) => {
  res.send("Backend is running with CORS and large payload support!");
});

// –°–ª–æ–≤–Ω–∏–∫ —Å—Ç–∏–ª—ñ–≤ —ñ–∑ –≤–∞—Ä—ñ–∞–Ω—Ç–∞–º–∏ + —Ç–µ–º–∞—Ç–∏—á–Ω—ñ –µ–º–æ–¥–∑—ñ
const vizPrompts = {
  "scatterplot": [
    "–¢–æ—á–∫–æ–≤–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üîµ",
    "–ù–∞ —Ç–æ—á–∫–æ–≤–æ–º—É –≥—Ä–∞—Ñ—ñ–∫—É –≤–∏–¥–Ω–æ üîµ",
    "Scatterplot –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üîµ"
  ],
  "qlik-variance-waterfall": [
    "–í–æ–¥–æ—Å–ø–∞–¥–Ω–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üåä",
    "Variance Waterfall –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üåä",
    "–ù–∞ –≤–æ–¥–æ—Å–ø–∞–¥—ñ –≤–∏–¥–Ω–æ üåä"
  ],
  "qlik-sankey-chart-ext": [
    "–î—ñ–∞–≥—Ä–∞–º–∞ –°–∞–Ω–∫—ñ –ø–æ–∫–∞–∑—É—î üîÄ",
    "Sankey –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –ø–æ—Ç–æ–∫–∏ üîÄ",
    "–ù–∞ –¥—ñ–∞–≥—Ä–∞–º—ñ –°–∞–Ω–∫—ñ –≤–∏–¥–Ω–æ üîÄ"
  ],
  "qlik-radar-chart": [
    "–†–∞–¥–∞—Ä–Ω–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üï∏Ô∏è",
    "–ù–∞ —Ä–∞–¥–∞—Ä—ñ –≤–∏–¥–Ω–æ üï∏Ô∏è",
    "–†–∞–¥–∞—Ä –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üï∏Ô∏è"
  ],
  "qlik-smart-pivot": [
    "P&L Pivot –ø–æ–∫–∞–∑—É—î üìä",
    "–ó–≤–µ–¥–µ–Ω–∞ P&L —Ç–∞–±–ª–∏—Ü—è –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìä",
    "Smart Pivot –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î üìä"
  ],
  "qlik-network-chart": [
    "–ú–µ—Ä–µ–∂–Ω–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üîó",
    "Network Chart –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î –∑–≤‚Äô—è–∑–∫–∏ üîó",
    "–ù–∞ –º–µ—Ä–µ–∂–Ω—ñ–π –¥—ñ–∞–≥—Ä–∞–º—ñ –≤–∏–¥–Ω–æ üîó"
  ],
  "qlik-funnel-chart-ext": [
    "–í–æ—Ä–æ–Ω–∫–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üîª",
    "Funnel Chart –ø–æ–∫–∞–∑—É—î üîª",
    "–ù–∞ –≤–æ—Ä–æ–Ω—Ü—ñ –≤–∏–¥–Ω–æ üîª"
  ],
  "waterfallchart": [
    "–ö–∞—Å–∫–∞–¥–Ω–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üåä",
    "Waterfall –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üåä",
    "–ù–∞ –∫–∞—Å–∫–∞–¥–Ω—ñ–π –¥—ñ–∞–≥—Ä–∞–º—ñ –≤–∏–¥–Ω–æ üåä"
  ],
  "treemap": [
    "–ö–∞—Ä—Ç–∞ –¥–µ—Ä–µ–≤–∞ –ø–æ–∫–∞–∑—É—î üå≥",
    "Treemap –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üå≥",
    "–ù–∞ –∫–∞—Ä—Ç—ñ –¥–µ—Ä–µ–≤–∞ –≤–∏–¥–Ω–æ üå≥"
  ],
  "text-image": [
    "–¢–µ–∫—Å—Ç–æ–≤–∏–π –±–ª–æ–∫ –ø–æ–∫–∞–∑—É—î üìù",
    "–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üñºÔ∏è",
    "–¢–µ–∫—Å—Ç/–∑–æ–±—Ä–∞–∂–µ–Ω–Ω—è –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î üñºÔ∏è"
  ],
  "table": [
    "–¢–∞–±–ª–∏—Ü—è –ø–æ–∫–∞–∑—É—î üìã",
    "–£ —Ç–∞–±–ª–∏—Ü—ñ –≤–∏–¥–Ω–æ üìã",
    "–¢–∞–±–ª–∏—á–Ω—ñ –¥–∞–Ω—ñ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—é—Ç—å üìã"
  ],
  "pivot-table": [
    "–ó–≤–µ–¥–µ–Ω–∞ —Ç–∞–±–ª–∏—Ü—è –ø–æ–∫–∞–∑—É—î üìä",
    "Pivot –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìä",
    "–£ –∑–≤–µ–¥–µ–Ω—ñ–π —Ç–∞–±–ª–∏—Ü—ñ –≤–∏–¥–Ω–æ üìä"
  ],
  "piechart": [
    "–ö—Ä—É–≥–æ–≤–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üç©",
    "Pie Chart –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üç©",
    "–ù–∞ –∫—Ä—É–≥–æ–≤—ñ–π –¥—ñ–∞–≥—Ä–∞–º—ñ –≤–∏–¥–Ω–æ üç©"
  ],
  "map": [
    "–ö–∞—Ä—Ç–∞ –ø–æ–∫–∞–∑—É—î üó∫Ô∏è",
    "–ù–∞ –∫–∞—Ä—Ç—ñ –≤–∏–¥–Ω–æ üó∫Ô∏è",
    "Map –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üó∫Ô∏è"
  ],
  "linechart": [
    "–õ—ñ–Ω—ñ–π–Ω–∏–π –≥—Ä–∞—Ñ—ñ–∫ –ø–æ–∫–∞–∑—É—î üìà",
    "–ù–∞ –≥—Ä–∞—Ñ—ñ–∫—É –≤–∏–¥–Ω–æ üìà",
    "Line Chart –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìà"
  ],
  "gauge": [
    "–î–∞—Ç—á–∏–∫ KPI –ø–æ–∫–∞–∑—É—î üéØ",
    "Gauge –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üéØ",
    "–ù–∞ KPI –≤–∏–¥–Ω–æ üéØ"
  ],
  "histogram": [
    "–ì—ñ—Å—Ç–æ–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üìä",
    "–ù–∞ –≥—ñ—Å—Ç–æ–≥—Ä–∞–º—ñ –≤–∏–¥–Ω–æ üìä",
    "Histogram –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìä"
  ],
  "distributionplot": [
    "–ì—Ä–∞—Ñ—ñ–∫ —Ä–æ–∑–ø–æ–¥—ñ–ª—É –ø–æ–∫–∞–∑—É—î üìä",
    "Distribution Plot –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìä",
    "–ù–∞ –≥—Ä–∞—Ñ—ñ–∫—É —Ä–æ–∑–ø–æ–¥—ñ–ª—É –≤–∏–¥–Ω–æ üìä"
  ],
  "combochart": [
    "–ö–æ–º–±—ñ–Ω–æ–≤–∞–Ω–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üìä",
    "Combo Chart –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìä",
    "–ù–∞ –∫–æ–º–±—ñ–Ω–æ–≤–∞–Ω—ñ–π –¥—ñ–∞–≥—Ä–∞–º—ñ –≤–∏–¥–Ω–æ üìä"
  ],
  "boxplot": [
    "Boxplot –ø–æ–∫–∞–∑—É—î üì¶",
    "–î—ñ–∞–≥—Ä–∞–º–∞ –∑ –∫–æ—Ä–æ–±–∫–∞–º–∏ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üì¶",
    "–ù–∞ Boxplot –≤–∏–¥–Ω–æ üì¶"
  ],
  "barchart": [
    "–°—Ç–æ–≤–ø—á–∏–∫–æ–≤–∞ –¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üìä",
    "Bar Chart –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìä",
    "–ù–∞ —Å—Ç–æ–≤–ø—á–∏–∫–∞—Ö –≤–∏–¥–Ω–æ üìä"
  ],
  "mekkochart": [
    "–ú–µ–∫–∫–æ-–¥—ñ–∞–≥—Ä–∞–º–∞ –ø–æ–∫–∞–∑—É—î üìä",
    "Marimekko –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìä",
    "–ù–∞ –ú–µ–∫–∫–æ –≤–∏–¥–Ω–æ üìä"
  ],
  "heatmap": [
    "–¢–µ–ø–ª–æ–≤–∞ –∫–∞—Ä—Ç–∞ –ø–æ–∫–∞–∑—É—î üî•",
    "Heatmap –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üî•",
    "–ù–∞ —Ç–µ–ø–ª–æ–≤—ñ–π –∫–∞—Ä—Ç—ñ –≤–∏–¥–Ω–æ üî•"
  ],
  "bulletchart": [
    "Bullet Chart –ø–æ–∫–∞–∑—É—î üéØ",
    "–ë—É–ª–ª–µ—Ç-–¥—ñ–∞–≥—Ä–∞–º–∞ –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üéØ",
    "–ù–∞ Bullet –≤–∏–¥–Ω–æ üéØ"
  ],
  "gantt": [
    "–î—ñ–∞–≥—Ä–∞–º–∞ –ì–∞–Ω—Ç–∞ –ø–æ–∫–∞–∑—É—î üìÖ",
    "Gantt Chart –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìÖ",
    "–ù–∞ –¥—ñ–∞–≥—Ä–∞–º—ñ –ì–∞–Ω—Ç–∞ –≤–∏–¥–Ω–æ üìÖ"
  ],
  "default": [
    "–î–∞–Ω—ñ –ø–æ–∫–∞–∑—É—é—Ç—å üìä",
    "–ó –¥–∞–Ω–∏—Ö –≤–∏–¥–Ω–æ üìä",
    "–Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –¥–µ–º–æ–Ω—Å—Ç—Ä—É—î üìä",
    "–†–µ–∑—É–ª—å—Ç–∞—Ç–∏ –ø–æ–∫–∞–∑—É—é—Ç—å üìä"
  ]
};

// –§—É–Ω–∫—Ü—ñ—è –≤–∏–±–æ—Ä—É –≤–∏–ø–∞–¥–∫–æ–≤–æ–≥–æ –≤–∞—Ä—ñ–∞–Ω—Ç—É
function pickPrompt(type) {
  const options = vizPrompts[type] || vizPrompts["default"];
  return options[Math.floor(Math.random() * options.length)];
}

// –û—Å–Ω–æ–≤–Ω–∏–π endpoint
app.post("/analyze", async (req, res) => {
  const { message, data, fields, vizType, metadata } = req.body;

  // –õ–æ–≥—É–≤–∞–Ω–Ω—è –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
  //console.log("Received body:", req.body);
  //–±–µ–∑ –ª–æ–≥—ñ–≤

  // –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–∏–π –≤–∏–±—ñ—Ä —Å—Ç–∏–ª—é
  const styleHint = pickPrompt(vizType);

  // –§–æ—Ä–º—É—î–º–æ –ø—Ä–æ–º–ø—Ç –¥–ª—è –º–æ–¥–µ–ª—ñ
const prompt = `
–¢–∏ –∞–Ω–∞–ª—ñ—Ç–∏—á–Ω–∏–π –∞—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è Qlik Sense.
–£ —Ç–µ–±–µ —î –Ω–∞–±—ñ—Ä –¥–∞–Ω–∏—Ö —É —Ñ–æ—Ä–º–∞—Ç—ñ JSON (–∑–º—ñ–Ω–Ω–∞ "data") —Ç–∞ —Å–ø–∏—Å–æ–∫ –ø–æ–ª—ñ–≤ (–º–∞—Å–∏–≤ "fields").
–¢–∞–∫–æ–∂ –≤—ñ–¥–æ–º–∏–π —Ç–∏–ø –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—ó (${vizType}).

–ü—Ä–∞–≤–∏–ª–∞:
- –Ø–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —î –∑–∞–≥–∞–ª—å–Ω–∏–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–∏–≤—ñ—Ç–∞–Ω–Ω—è —á–∏ small talk), –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π –¥—Ä—É–∂–Ω—å–æ —è–∫ –∞—Å–∏—Å—Ç–µ–Ω—Ç, –º–æ–∂–µ—à –¥–æ–¥–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω—ñ –µ–º–æ–¥–∑—ñ (üëã, üòä, üëç —Ç–æ—â–æ).
- –Ø–∫—â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å—Ç–æ—Å—É—î—Ç—å—Å—è –¥–∞–Ω–∏—Ö, –∞–Ω–∞–ª—ñ–∑—É–π —ó—Ö, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ "data" —Ç–∞ "fields", —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–π —Ç–∞–∫, –Ω—ñ–±–∏ —Ç–∏ –±–∞—á–∏—à –≤—ñ–∑—É–∞–ª—ñ–∑–∞—Ü—ñ—é —Ç–∏–ø—É "${vizType}".
- –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π —Å—Ç–∏–ª—å —É –¥—É—Å—ñ: "${styleHint}", –∞–ª–µ –≤–∞—Ä—ñ—é–π —Ñ–æ—Ä–º—É–ª—é–≤–∞–Ω–Ω—è.
- –Ø–∫—â–æ –¥–∞–Ω–∏—Ö –Ω–µ–º–∞—î, —á—ñ—Ç–∫–æ —Å–∫–∞–∂–∏ "–ù–µ–º–∞—î –¥–∞–Ω–∏—Ö".
- –ù–µ –≤–∏–≥–∞–¥—É–π –∑–Ω–∞—á–µ–Ω–Ω—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –ª–∏—à–µ —Ç–µ, —â–æ —î —É JSON.
- –î–æ–¥–∞–≤–∞–π –µ–º–æ–¥–∑—ñ –Ω–∞ –≤–ª–∞—Å–Ω–∏–π —Ä–æ–∑—Å—É–¥, –∞–ª–µ –ø–æ–º—ñ—Ä–Ω–æ: –ª–∏—à–µ —Ç–∞–º, –¥–µ –≤–æ–Ω–∏ —Å–ø—Ä–∞–≤–¥—ñ –ø—ñ–¥—Å–∏–ª—é—é—Ç—å –∑–º—ñ—Å—Ç.
- –Ø–∫—â–æ –≤ –¥–∞–Ω–∏—Ö —î –ø–æ–ª–µ LOGO (–ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –ª–æ–≥–æ—Ç–∏–ø), –∑–∞–≤–∂–¥–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞–π –π–æ–≥–æ –±—ñ–ª—è –Ω–∞–∑–≤–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ –æ–±‚Äô—î–∫—Ç–∞ —É —Ñ–æ—Ä–º–∞—Ç—ñ: <img src="LOGO_URL" style="width:16px;height:16px;vertical-align:middle;margin-right:4px;" alt="—ñ–∫–æ–Ω–∫–∞"> OBJECT_NAME. –Ø–∫—â–æ –ø–æ–ª–µ LOGO –ø–æ—Ä–æ–∂–Ω—î ‚Äî –ø–æ–∫–∞–∑—É–π —Ç—ñ–ª—å–∫–∏ –Ω–∞–∑–≤—É –æ–±‚Äô—î–∫—Ç–∞.
- –Ø–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—Ä–æ—Å–∏—Ç—å "executive summary":
   * –í—ñ–¥–ø–æ–≤—ñ–¥–∞–π —Å—Ç–∏—Å–ª–æ (3‚Äì4 —Ä–µ—á–µ–Ω–Ω—è).
   * –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π –¥—ñ–ª–æ–≤–∏–π —Å—Ç–∏–ª—å, –±–µ–∑ –∑–∞–π–≤–∏—Ö –¥–µ—Ç–∞–ª–µ–π.
   * –î–æ–¥–∞–π –∫–æ—Ä–æ—Ç–∫–∏–π –±–ª–æ–∫ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü—ñ–π (2‚Äì3 –ø—É–Ω–∫—Ç–∏).
   * –ù–µ –≤—Å—Ç–∞–≤–ª—è–π —Ç–∞–±–ª–∏—Ü—ñ —á–∏ –¥–æ–≤–≥—ñ —Å–ø–∏—Å–∫–∏, —Ç—ñ–ª—å–∫–∏ –∫–ª—é—á–æ–≤—ñ –≤–∏—Å–Ω–æ–≤–∫–∏.
`;



  try {
const response = await client.chat.completions.create({
  model: "gpt-4.1-mini",
  messages: [
    { role: "system", content: prompt }, // —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó
    { role: "user", content: message },  // —Ä–µ–∞–ª—å–Ω–∏–π –∑–∞–ø–∏—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    { role: "assistant", content: "–û—Å—å –¥–∞–Ω—ñ:\n" + JSON.stringify(data) + "\n–ü–æ–ª—è:\n" + JSON.stringify(fields) }
  ]
});


    const reply = response.choices?.[0]?.message?.content || "–ü–æ–º–∏–ª–∫–∞: –Ω–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ –º–æ–¥–µ–ª—ñ";
    res.json({ reply });
  } catch (error) {
    console.error("Error calling OpenAI:", error);
    res.status(500).json({ error: "–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–∫–ª–∏–∫—É –º–æ–¥–µ–ª—ñ" });
  }
});

// —Å–ª—É—Ö–∞—î–º–æ –ø–æ—Ä—Ç —ñ–∑ Railway
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Backend running on port ${PORT}`);
});