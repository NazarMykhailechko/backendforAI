import express from "express";
import cors from "cors";
import OpenAI from "openai";

const app = express();

// Ð·Ð±Ñ–Ð»ÑŒÑˆÑƒÑ”Ð¼Ð¾ Ð»Ñ–Ð¼Ñ–Ñ‚ Ð´Ð»Ñ Ð²ÐµÐ»Ð¸ÐºÐ¸Ñ… Ð¼Ð°ÑÐ¸Ð²Ñ–Ð² (Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´, 10mb)
app.use(express.json({ limit: "10mb" }));

// Ð´Ð¾Ð·Ð²Ð¾Ð»ÑÑ”Ð¼Ð¾ Ð·Ð°Ð¿Ð¸Ñ‚Ð¸ Ð· Ñ‚Ð²Ð¾Ð³Ð¾ Qlik-Ð´Ð¾Ð¼ÐµÐ½Ñƒ
app.use(cors({
  origin: "https://bi_qlik.accordbank.com.ua"
}));

// Ð†Ð½Ñ–Ñ†Ñ–Ð°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ OpenAI
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
});

// Ð¿Ñ€Ð¾ÑÑ‚Ð¸Ð¹ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ñ–Ñ€ÐºÐ¸
app.get("/", (req, res) => {
  res.send("Backend is running with CORS and large payload support!");
});

// Ð¡Ð»Ð¾Ð²Ð½Ð¸Ðº ÑÑ‚Ð¸Ð»Ñ–Ð² Ñ–Ð· Ð²Ð°Ñ€Ñ–Ð°Ð½Ñ‚Ð°Ð¼Ð¸ + Ñ‚ÐµÐ¼Ð°Ñ‚Ð¸Ñ‡Ð½Ñ– ÐµÐ¼Ð¾Ð´Ð·Ñ–
const vizPrompts = {
  "scatterplot": [
    "Ð¢Ð¾Ñ‡ÐºÐ¾Ð²Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ”µ",
    "ÐÐ° Ñ‚Ð¾Ñ‡ÐºÐ¾Ð²Ð¾Ð¼Ñƒ Ð³Ñ€Ð°Ñ„Ñ–ÐºÑƒ Ð²Ð¸Ð´Ð½Ð¾ ðŸ”µ",
    "Scatterplot Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ”µ"
  ],
  "qlik-variance-waterfall": [
    "Ð’Ð¾Ð´Ð¾ÑÐ¿Ð°Ð´Ð½Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸŒŠ",
    "Variance Waterfall Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸŒŠ",
    "ÐÐ° Ð²Ð¾Ð´Ð¾ÑÐ¿Ð°Ð´Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸŒŠ"
  ],
  "qlik-sankey-chart-ext": [
    "Ð”Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¡Ð°Ð½ÐºÑ– Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ”€",
    "Sankey Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” Ð¿Ð¾Ñ‚Ð¾ÐºÐ¸ ðŸ”€",
    "ÐÐ° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð¡Ð°Ð½ÐºÑ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ”€"
  ],
  "qlik-radar-chart": [
    "Ð Ð°Ð´Ð°Ñ€Ð½Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ•¸ï¸",
    "ÐÐ° Ñ€Ð°Ð´Ð°Ñ€Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ•¸ï¸",
    "Ð Ð°Ð´Ð°Ñ€ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ•¸ï¸"
  ],
  "qlik-smart-pivot": [
    "P&L Pivot Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“Š",
    "Ð—Ð²ÐµÐ´ÐµÐ½Ð° P&L Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "Smart Pivot Ð²Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ” ðŸ“Š"
  ],
  "qlik-network-chart": [
    "ÐœÐµÑ€ÐµÐ¶Ð½Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ”—",
    "Network Chart Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” Ð·Ð²â€™ÑÐ·ÐºÐ¸ ðŸ”—",
    "ÐÐ° Ð¼ÐµÑ€ÐµÐ¶Ð½Ñ–Ð¹ Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ”—"
  ],
  "qlik-funnel-chart-ext": [
    "Ð’Ð¾Ñ€Ð¾Ð½ÐºÐ° Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ”»",
    "Funnel Chart Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ”»",
    "ÐÐ° Ð²Ð¾Ñ€Ð¾Ð½Ñ†Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ”»"
  ],
  "waterfallchart": [
    "ÐšÐ°ÑÐºÐ°Ð´Ð½Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸŒŠ",
    "Waterfall Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸŒŠ",
    "ÐÐ° ÐºÐ°ÑÐºÐ°Ð´Ð½Ñ–Ð¹ Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸŒŠ"
  ],
  "treemap": [
    "ÐšÐ°Ñ€Ñ‚Ð° Ð´ÐµÑ€ÐµÐ²Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸŒ³",
    "Treemap Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸŒ³",
    "ÐÐ° ÐºÐ°Ñ€Ñ‚Ñ– Ð´ÐµÑ€ÐµÐ²Ð° Ð²Ð¸Ð´Ð½Ð¾ ðŸŒ³"
  ],
  "text-image": [
    "Ð¢ÐµÐºÑÑ‚Ð¾Ð²Ð¸Ð¹ Ð±Ð»Ð¾Ðº Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“",
    "Ð—Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ–¼ï¸",
    "Ð¢ÐµÐºÑÑ‚/Ð·Ð¾Ð±Ñ€Ð°Ð¶ÐµÐ½Ð½Ñ Ð²Ñ–Ð´Ð¾Ð±Ñ€Ð°Ð¶Ð°Ñ” ðŸ–¼ï¸"
  ],
  "table": [
    "Ð¢Ð°Ð±Ð»Ð¸Ñ†Ñ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“‹",
    "Ð£ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ“‹",
    "Ð¢Ð°Ð±Ð»Ð¸Ñ‡Ð½Ñ– Ð´Ð°Ð½Ñ– Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑŽÑ‚ÑŒ ðŸ“‹"
  ],
  "pivot-table": [
    "Ð—Ð²ÐµÐ´ÐµÐ½Ð° Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“Š",
    "Pivot Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "Ð£ Ð·Ð²ÐµÐ´ÐµÐ½Ñ–Ð¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š"
  ],
  "piechart": [
    "ÐšÑ€ÑƒÐ³Ð¾Ð²Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ©",
    "Pie Chart Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ©",
    "ÐÐ° ÐºÑ€ÑƒÐ³Ð¾Ð²Ñ–Ð¹ Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ©"
  ],
  "map": [
    "ÐšÐ°Ñ€Ñ‚Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ—ºï¸",
    "ÐÐ° ÐºÐ°Ñ€Ñ‚Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ—ºï¸",
    "Map Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ—ºï¸"
  ],
  "linechart": [
    "Ð›Ñ–Ð½Ñ–Ð¹Ð½Ð¸Ð¹ Ð³Ñ€Ð°Ñ„Ñ–Ðº Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“ˆ",
    "ÐÐ° Ð³Ñ€Ð°Ñ„Ñ–ÐºÑƒ Ð²Ð¸Ð´Ð½Ð¾ ðŸ“ˆ",
    "Line Chart Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“ˆ"
  ],
  "gauge": [
    "Ð”Ð°Ñ‚Ñ‡Ð¸Ðº KPI Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸŽ¯",
    "Gauge Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸŽ¯",
    "ÐÐ° KPI Ð²Ð¸Ð´Ð½Ð¾ ðŸŽ¯"
  ],
  "histogram": [
    "Ð“Ñ–ÑÑ‚Ð¾Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“Š",
    "ÐÐ° Ð³Ñ–ÑÑ‚Ð¾Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š",
    "Histogram Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š"
  ],
  "distributionplot": [
    "Ð“Ñ€Ð°Ñ„Ñ–Ðº Ñ€Ð¾Ð·Ð¿Ð¾Ð´Ñ–Ð»Ñƒ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“Š",
    "Distribution Plot Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "ÐÐ° Ð³Ñ€Ð°Ñ„Ñ–ÐºÑƒ Ñ€Ð¾Ð·Ð¿Ð¾Ð´Ñ–Ð»Ñƒ Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š"
  ],
  "combochart": [
    "ÐšÐ¾Ð¼Ð±Ñ–Ð½Ð¾Ð²Ð°Ð½Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“Š",
    "Combo Chart Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "ÐÐ° ÐºÐ¾Ð¼Ð±Ñ–Ð½Ð¾Ð²Ð°Ð½Ñ–Ð¹ Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š"
  ],
  "boxplot": [
    "Boxplot Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“¦",
    "Ð”Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð· ÐºÐ¾Ñ€Ð¾Ð±ÐºÐ°Ð¼Ð¸ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“¦",
    "ÐÐ° Boxplot Ð²Ð¸Ð´Ð½Ð¾ ðŸ“¦"
  ],
  "barchart": [
    "Ð¡Ñ‚Ð¾Ð²Ð¿Ñ‡Ð¸ÐºÐ¾Ð²Ð° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“Š",
    "Bar Chart Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "ÐÐ° ÑÑ‚Ð¾Ð²Ð¿Ñ‡Ð¸ÐºÐ°Ñ… Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š"
  ],
  "mekkochart": [
    "ÐœÐµÐºÐºÐ¾-Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“Š",
    "Marimekko Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "ÐÐ° ÐœÐµÐºÐºÐ¾ Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š"
  ],
  "heatmap": [
    "Ð¢ÐµÐ¿Ð»Ð¾Ð²Ð° ÐºÐ°Ñ€Ñ‚Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ”¥",
    "Heatmap Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ”¥",
    "ÐÐ° Ñ‚ÐµÐ¿Ð»Ð¾Ð²Ñ–Ð¹ ÐºÐ°Ñ€Ñ‚Ñ– Ð²Ð¸Ð´Ð½Ð¾ ðŸ”¥"
  ],
  "bulletchart": [
    "Bullet Chart Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸŽ¯",
    "Ð‘ÑƒÐ»Ð»ÐµÑ‚-Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸŽ¯",
    "ÐÐ° Bullet Ð²Ð¸Ð´Ð½Ð¾ ðŸŽ¯"
  ],
  "gantt": [
    "Ð”Ñ–Ð°Ð³Ñ€Ð°Ð¼Ð° Ð“Ð°Ð½Ñ‚Ð° Ð¿Ð¾ÐºÐ°Ð·ÑƒÑ” ðŸ“…",
    "Gantt Chart Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“…",
    "ÐÐ° Ð´Ñ–Ð°Ð³Ñ€Ð°Ð¼Ñ– Ð“Ð°Ð½Ñ‚Ð° Ð²Ð¸Ð´Ð½Ð¾ ðŸ“…"
  ],
  "default": [
    "Ð”Ð°Ð½Ñ– Ð¿Ð¾ÐºÐ°Ð·ÑƒÑŽÑ‚ÑŒ ðŸ“Š",
    "Ð— Ð´Ð°Ð½Ð¸Ñ… Ð²Ð¸Ð´Ð½Ð¾ ðŸ“Š",
    "Ð†Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ñ–Ñ Ð´ÐµÐ¼Ð¾Ð½ÑÑ‚Ñ€ÑƒÑ” ðŸ“Š",
    "Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¸ Ð¿Ð¾ÐºÐ°Ð·ÑƒÑŽÑ‚ÑŒ ðŸ“Š"
  ]
};

// Ð¤ÑƒÐ½ÐºÑ†Ñ–Ñ Ð²Ð¸Ð±Ð¾Ñ€Ñƒ Ð²Ð¸Ð¿Ð°Ð´ÐºÐ¾Ð²Ð¾Ð³Ð¾ Ð²Ð°Ñ€Ñ–Ð°Ð½Ñ‚Ñƒ
function pickPrompt(type) {
  const options = vizPrompts[type] || vizPrompts["default"];
  return options[Math.floor(Math.random() * options.length)];
}

// ÐžÑÐ½Ð¾Ð²Ð½Ð¸Ð¹ endpoint
app.post("/analyze", async (req, res) => {
  const { message, data, fields, vizType, metadata } = req.body;

  // Ð›Ð¾Ð³ÑƒÐ²Ð°Ð½Ð½Ñ Ð´Ð»Ñ Ð´Ñ–Ð°Ð³Ð½Ð¾ÑÑ‚Ð¸ÐºÐ¸
  console.log("Received body:", req.body);

  // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡Ð½Ð¸Ð¹ Ð²Ð¸Ð±Ñ–Ñ€ ÑÑ‚Ð¸Ð»ÑŽ
  const styleHint = pickPrompt(vizType);

  // Ð¤Ð¾Ñ€Ð¼ÑƒÑ”Ð¼Ð¾ Ð¿Ñ€Ð¾Ð¼Ð¿Ñ‚ Ð´Ð»Ñ Ð¼Ð¾Ð´ÐµÐ»Ñ–
const prompt = `
Ð¢Ð¸ Ð°Ð½Ð°Ð»Ñ–Ñ‚Ð¸Ñ‡Ð½Ð¸Ð¹ Ð°ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚ Ð´Ð»Ñ Qlik Sense.
Ð£ Ñ‚ÐµÐ±Ðµ Ñ” Ð½Ð°Ð±Ñ–Ñ€ Ð´Ð°Ð½Ð¸Ñ… Ñƒ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ– JSON (Ð·Ð¼Ñ–Ð½Ð½Ð° "data") Ñ‚Ð° ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ð»Ñ–Ð² (Ð¼Ð°ÑÐ¸Ð² "fields").
Ð¢Ð°ÐºÐ¾Ð¶ Ð²Ñ–Ð´Ð¾Ð¼Ð¸Ð¹ Ñ‚Ð¸Ð¿ Ð²Ñ–Ð·ÑƒÐ°Ð»Ñ–Ð·Ð°Ñ†Ñ–Ñ— (${vizType}).

ÐŸÑ€Ð°Ð²Ð¸Ð»Ð°:
- Ð¯ÐºÑ‰Ð¾ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð° Ñ” Ð·Ð°Ð³Ð°Ð»ÑŒÐ½Ð¸Ð¼ (Ð½Ð°Ð¿Ñ€Ð¸ÐºÐ»Ð°Ð´, Ð¿Ñ€Ð¸Ð²Ñ–Ñ‚Ð°Ð½Ð½Ñ Ñ‡Ð¸ small talk), Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ð´Ñ€ÑƒÐ¶Ð½ÑŒÐ¾ ÑÐº Ð°ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚, Ð¼Ð¾Ð¶ÐµÑˆ Ð´Ð¾Ð´Ð°Ñ‚Ð¸ Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð½Ñ– ÐµÐ¼Ð¾Ð´Ð·Ñ– (ðŸ‘‹, ðŸ˜Š, ðŸ‘ Ñ‚Ð¾Ñ‰Ð¾).
- Ð¯ÐºÑ‰Ð¾ Ð¿Ð¾Ð²Ñ–Ð´Ð¾Ð¼Ð»ÐµÐ½Ð½Ñ ÑÑ‚Ð¾ÑÑƒÑ”Ñ‚ÑŒÑÑ Ð´Ð°Ð½Ð¸Ñ…, Ð°Ð½Ð°Ð»Ñ–Ð·ÑƒÐ¹ Ñ—Ñ…, Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÑŽÑ‡Ð¸ "data" Ñ‚Ð° "fields", Ñ– Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ Ñ‚Ð°Ðº, Ð½Ñ–Ð±Ð¸ Ñ‚Ð¸ Ð±Ð°Ñ‡Ð¸Ñˆ Ð²Ñ–Ð·ÑƒÐ°Ð»Ñ–Ð·Ð°Ñ†Ñ–ÑŽ Ñ‚Ð¸Ð¿Ñƒ "${vizType}".
- Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ ÑÑ‚Ð¸Ð»ÑŒ Ñƒ Ð´ÑƒÑÑ–: "${styleHint}", Ð°Ð»Ðµ Ð²Ð°Ñ€Ñ–ÑŽÐ¹ Ñ„Ð¾Ñ€Ð¼ÑƒÐ»ÑŽÐ²Ð°Ð½Ð½Ñ.
- Ð¯ÐºÑ‰Ð¾ Ð´Ð°Ð½Ð¸Ñ… Ð½ÐµÐ¼Ð°Ñ”, Ñ‡Ñ–Ñ‚ÐºÐ¾ ÑÐºÐ°Ð¶Ð¸ "ÐÐµÐ¼Ð°Ñ” Ð´Ð°Ð½Ð¸Ñ…".
- ÐÐµ Ð²Ð¸Ð³Ð°Ð´ÑƒÐ¹ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ñ, Ð²Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ Ð»Ð¸ÑˆÐµ Ñ‚Ðµ, Ñ‰Ð¾ Ñ” Ñƒ JSON.
- Ð”Ð¾Ð´Ð°Ð²Ð°Ð¹ ÐµÐ¼Ð¾Ð´Ð·Ñ– Ð½Ð° Ð²Ð»Ð°ÑÐ½Ð¸Ð¹ Ñ€Ð¾Ð·ÑÑƒÐ´, Ð°Ð»Ðµ Ð¿Ð¾Ð¼Ñ–Ñ€Ð½Ð¾: Ð»Ð¸ÑˆÐµ Ñ‚Ð°Ð¼, Ð´Ðµ Ð²Ð¾Ð½Ð¸ ÑÐ¿Ñ€Ð°Ð²Ð´Ñ– Ð¿Ñ–Ð´ÑÐ¸Ð»ÑŽÑŽÑ‚ÑŒ Ð·Ð¼Ñ–ÑÑ‚.
- Ð¯ÐºÑ‰Ð¾ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡ Ð¿Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ "executive summary":
   * Ð’Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ð°Ð¹ ÑÑ‚Ð¸ÑÐ»Ð¾ (3â€“4 Ñ€ÐµÑ‡ÐµÐ½Ð½Ñ).
   * Ð’Ð¸ÐºÐ¾Ñ€Ð¸ÑÑ‚Ð¾Ð²ÑƒÐ¹ Ð´Ñ–Ð»Ð¾Ð²Ð¸Ð¹ ÑÑ‚Ð¸Ð»ÑŒ, Ð±ÐµÐ· Ð·Ð°Ð¹Ð²Ð¸Ñ… Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹.
   * Ð”Ð¾Ð´Ð°Ð¹ ÐºÐ¾Ñ€Ð¾Ñ‚ÐºÐ¸Ð¹ Ð±Ð»Ð¾Ðº Ñ€ÐµÐºÐ¾Ð¼ÐµÐ½Ð´Ð°Ñ†Ñ–Ð¹ (2â€“3 Ð¿ÑƒÐ½ÐºÑ‚Ð¸).
   * ÐÐµ Ð²ÑÑ‚Ð°Ð²Ð»ÑÐ¹ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ– Ñ‡Ð¸ Ð´Ð¾Ð²Ð³Ñ– ÑÐ¿Ð¸ÑÐºÐ¸, Ñ‚Ñ–Ð»ÑŒÐºÐ¸ ÐºÐ»ÑŽÑ‡Ð¾Ð²Ñ– Ð²Ð¸ÑÐ½Ð¾Ð²ÐºÐ¸.
`;



  try {
const response = await client.chat.completions.create({
  model: "gpt-4.1-mini",
  messages: [
    { role: "system", content: prompt }, // Ñ–Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ñ–Ñ—
    { role: "user", content: message },  // Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¸Ð¹ Ð·Ð°Ð¿Ð¸Ñ‚ ÐºÐ¾Ñ€Ð¸ÑÑ‚ÑƒÐ²Ð°Ñ‡Ð°
    { role: "assistant", content: "ÐžÑÑŒ Ð´Ð°Ð½Ñ–:\n" + JSON.stringify(data) + "\nÐŸÐ¾Ð»Ñ:\n" + JSON.stringify(fields) }
  ]
});


    const reply = response.choices?.[0]?.message?.content || "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ°: Ð½ÐµÐ¼Ð°Ñ” Ð²Ñ–Ð´Ð¿Ð¾Ð²Ñ–Ð´Ñ– Ð²Ñ–Ð´ Ð¼Ð¾Ð´ÐµÐ»Ñ–";
    res.json({ reply });
  } catch (error) {
    console.error("Error calling OpenAI:", error);
    res.status(500).json({ error: "ÐŸÐ¾Ð¼Ð¸Ð»ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ð¸ÐºÐ»Ð¸ÐºÑƒ Ð¼Ð¾Ð´ÐµÐ»Ñ–" });
  }
});

// ÑÐ»ÑƒÑ…Ð°Ñ”Ð¼Ð¾ Ð¿Ð¾Ñ€Ñ‚ Ñ–Ð· Railway
const PORT = process.env.PORT || 3000;
app.listen(PORT, () => {
  console.log(`Backend running on port ${PORT}`);
});